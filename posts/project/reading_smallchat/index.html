<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="smallchat1 æ˜¯ redis ä½œè€… antirez æ‰€å†™çš„ä¸€ä¸ªèŠå¤©å®¤çš„å°ç¨‹åºï¼›ä»£ç çŸ­å°ç²¾æ‚ï¼Œå¾ˆæœ‰æ„æ€ã€‚æ®è¯´ä½œè€…ä»¥æ­¤ä¾‹å‘å‰ç«¯æœ‹å‹å±•ç¤ºç³»ç»Ÿç¼–ç¨‹çš„è¶£å‘³ ğŸ˜„ 2~
è¿™é‡Œè®°å½•ä¸‹é˜…è¯»æºç æ‰€è·ã€‚
é¦–å…ˆä» main å¼€å§‹:
/* The main() function implements the main chat logic: * 1. Accept new clients connections if any. * 2. Check if any client sent us some new message. * 3. Send the message to all the other clients. */ int main(void) { initChat(); while(1) { ... } return 0; } æ ¹æ®æ³¨é‡Šï¼Œmain å‡½æ•°ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š
æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼› æ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘é€è¿‡æ¥æ–°çš„æ¶ˆæ¯ï¼› å‘é€æ¶ˆæ¯ç»™å…¶ä»–å®¢æˆ·ç«¯ï¼› ä»£ç é¦–å…ˆè°ƒç”¨äº† initChat å®Œæˆä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼›ç„¶åç¨‹åºè¿›å…¥åˆ°æ­»å¾ªç¯ï¼Œä½œä¸ºå¸¸é©»æœåŠ¡ï¼Œä¼šä¸åœæ‰§è¡Œæ¶ˆæ¯é€»è¾‘ã€‚ä¸»é¢˜ç»“æ„å¤§ä½“æ˜¯è¿™æ ·ã€‚"><title>smallchat æºç é˜…è¯»
</title><link rel="shortcut icon" type=image/x-icon href=/><link rel=stylesheet href=/css/main.ebe15b0394daa6798b8a40aa572a71b5a7a1beb8cc02c392f5c142e7d08ddb6052e049639385106440b538f394884685082b7441eef27a6a8315ec723155dc15.css integrity="sha512-6+FbA5TapnmLikCqVypxtaehvrjMAsOS9cFC59CN22BS4Eljk4UQZEC1OPOUiEaFCCt0Qe7yemqDFexyMVXcFQ=="></head><body a=auto><main class=page-content aria-label=Content><div class=w><a href=/>..</a><article><p class=post-meta><time datetime="2023-11-04 23:35:15 +0800 +0800">2023-11-04</time></p><h1>smallchat æºç é˜…è¯»</h1><p><code>smallchat</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> æ˜¯ <code>redis</code> ä½œè€… <code>antirez</code> æ‰€å†™çš„ä¸€ä¸ªèŠå¤©å®¤çš„å°ç¨‹åºï¼›ä»£ç çŸ­å°ç²¾æ‚ï¼Œå¾ˆæœ‰æ„æ€ã€‚æ®è¯´ä½œè€…ä»¥æ­¤ä¾‹å‘å‰ç«¯æœ‹å‹å±•ç¤ºç³»ç»Ÿç¼–ç¨‹çš„è¶£å‘³ ğŸ˜„ <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>~</p><p>è¿™é‡Œè®°å½•ä¸‹é˜…è¯»æºç æ‰€è·ã€‚</p><p>é¦–å…ˆä» <code>main</code> å¼€å§‹:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* The main() function implements the main chat logic:
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 1. Accept new clients connections if any.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 2. Check if any client sent us some new message.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 3. Send the message to all the other clients. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>initChat</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ ¹æ®æ³¨é‡Šï¼Œ<code>main</code> å‡½æ•°ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š</p><ol><li>æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼›</li><li>æ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘é€è¿‡æ¥æ–°çš„æ¶ˆæ¯ï¼›</li><li>å‘é€æ¶ˆæ¯ç»™å…¶ä»–å®¢æˆ·ç«¯ï¼›</li></ol><p>ä»£ç é¦–å…ˆè°ƒç”¨äº† <code>initChat</code> å®Œæˆä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼›ç„¶åç¨‹åºè¿›å…¥åˆ°æ­»å¾ªç¯ï¼Œä½œä¸ºå¸¸é©»æœåŠ¡ï¼Œä¼šä¸åœæ‰§è¡Œæ¶ˆæ¯é€»è¾‘ã€‚ä¸»é¢˜ç»“æ„å¤§ä½“æ˜¯è¿™æ ·ã€‚</p><hr><p>é‚£ä¹ˆæ¥çœ‹ä¸‹ <code>initChat</code> åšäº†å“ªäº›äº‹æƒ…ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#define MAX_CLIENTS 1000 </span><span style=color:#75715e>// This is actually the higher file descriptor.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define SERVER_PORT 7711
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* This structure represents a connected client. There is very little
</span></span></span><span style=display:flex><span><span style=color:#75715e> * info about it: the socket descriptor and the nick name, if set, otherwise
</span></span></span><span style=display:flex><span><span style=color:#75715e> * the first byte of the nickname is set to 0 if not set.
</span></span></span><span style=display:flex><span><span style=color:#75715e> * The client can set its nickname with /nick &lt;nickname&gt; command. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> client {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> fd;     <span style=color:#75715e>// Client socket.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>nick; <span style=color:#75715e>// Nickname of the client.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* This global structure encasulates the global state of the chat. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> chatState {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> serversock;     <span style=color:#75715e>// Listening server socket.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> numclients;     <span style=color:#75715e>// Number of connected clients right now.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> maxclient;      <span style=color:#75715e>// The greatest &#39;clients&#39; slot populated.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> client <span style=color:#f92672>*</span>clients[MAX_CLIENTS]; <span style=color:#75715e>// Clients are set in the corresponding
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                         <span style=color:#75715e>// slot of their socket descriptor.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> chatState <span style=color:#f92672>*</span>Chat; <span style=color:#75715e>// Initialized at startup.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* Allocate and init the global stuff. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChat</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    Chat <span style=color:#f92672>=</span> <span style=color:#a6e22e>chatMalloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#f92672>*</span>Chat));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(Chat,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>sizeof</span>(<span style=color:#f92672>*</span>Chat));
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* No clients at startup, of course. */</span>
</span></span><span style=display:flex><span>    Chat<span style=color:#f92672>-&gt;</span>maxclient <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#75715e>// è®°å½•å½“å‰æœ€å¤§å®¢æˆ·ç«¯æ§½æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Chat<span style=color:#f92672>-&gt;</span>numclients <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>// è®°å½•å½“å‰çš„å®¢æˆ·ç«¯è¿æ¥æ•°
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Create our listening socket, bound to the given port. This
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * is where our clients will connect. */</span>
</span></span><span style=display:flex><span>    Chat<span style=color:#f92672>-&gt;</span>serversock <span style=color:#f92672>=</span> <span style=color:#a6e22e>createTCPServer</span>(SERVER_PORT);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Chat<span style=color:#f92672>-&gt;</span>serversock <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;Creating listening socket&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>chatMalloc</span>(<span style=color:#66d9ef>size_t</span> size) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>ptr <span style=color:#f92672>=</span> <span style=color:#a6e22e>malloc</span>(size);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ptr <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;Out of memory&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> ptr;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>initChat</code> æ³¨é‡Šè¯´æ˜¯è´Ÿè´£åˆ†é…å’Œåˆå§‹åŒ–å…¨å±€å˜é‡ã€‚</p><p>é¡ºä¾¿æä¸€ä¸‹ï¼Œ <code>C</code> è¯­è¨€ä¸­æ˜¯éœ€è¦æ‰‹åŠ¨åšåŠ¨æ€å†…å­˜ç®¡ç†çš„ï¼Œå…·ä½“æ˜¯éœ€è¦ç”³è¯·å’Œå›æ”¶åŠ¨æ€å †å†…å­˜ã€‚å¦‚æœæ˜¯å¸¸é©»è¿›ç¨‹ï¼Œç”³è¯·åä¸å›æ”¶ä¼šå¯¼è‡´å†…å­˜æ³„éœ²ï¼Œä¸¥é‡æ—¶ä¼šå¯¼è‡´ç¨‹åº OOM è¢«ç³»ç»Ÿæ€æ­»é€€å‡ºï¼›ç¨‹åºçš„å†…å­˜ä¼šåœ¨é€€å‡ºåï¼Œç”±ç³»ç»Ÿå›æ”¶ã€‚</p><p>æ­¤å¤–åœ¨ç”³è¯·åˆ°åŠ¨æ€å†…å­˜åéœ€è¦æ‰‹åŠ¨æ¸…é›¶åˆå§‹åŒ–åä½¿ç”¨ï¼ˆå¦åˆ™ä¼šæœ‰æ®‹ç•™çš„éšæœºå€¼ï¼‰ã€‚
ç¨‹åºé‡Œ<code>malloc</code> å’Œ <code>free</code> å°±æ˜¯ç”¨æ¥åšåŠ¨æ€å†…å­˜ç”³è¯·å’Œå›æ”¶å‡½æ•°, <code>memset</code> ç”¨æ¥æ¸…é›¶åˆå§‹åŒ–ã€‚</p><p>ç¨‹åºå£°æ˜äº†å…¨å±€å˜é‡ <code>Chat</code> æ¥ä¿å­˜èŠå¤©å®¤çš„å…¨å±€çŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li><code>serversock</code> ç”¨æ¥ä¿å­˜æœåŠ¡ç›‘å¬è¿æ¥, ç”¨æ¥å¤„ç†æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼›</li><li><code>numclients</code> å’Œ <code>maxclient</code> ç”¨æ¥è®°å½•å®¢æˆ·ç«¯è¿æ¥æ•°çš„çŠ¶æ€ï¼›</li><li><code>client</code> æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œç”¨æ¥ä¿å­˜æ‰€æœ‰æ¥å…¥çš„å®¢æˆ·ç«¯è¿æ¥ï¼ˆç”¨ <code>client</code> ç»“æ„è®°å½•ï¼‰ï¼›</li></ol><p>ç¨‹åºåˆå§‹åŒ–ä¸º <code>Chat</code> ç”³è¯·äº†å†…å­˜ï¼Œå¹¶æ¸…é›¶å’Œåˆå§‹åŒ–ã€‚é€šè¿‡ <code>createTCPServer</code> åˆ›å»ºäº†æœåŠ¡è¿æ¥ï¼Œä¿å­˜åœ¨<code>serversock</code> å­—æ®µã€‚åˆå§‹åŒ–å°±å®Œæˆäº†ã€‚</p><hr><p>å¥½å¥‡ <code>createTCPServer</code> éƒ½åšäº†å“ªäº›äº‹ï¼Ÿå±äºååº•å±‚çš„ç½‘ç»œç¼–ç¨‹èŒƒç•´äº†ï¼Œä¸äºæ˜¯ <code>redis</code> çš„ä½œè€…ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Create a TCP socket lisetning to &#39;port&#39; ready to accept connections. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>createTCPServer</span>(<span style=color:#66d9ef>int</span> port) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> s, yes <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> sockaddr_in sa;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((s <span style=color:#f92672>=</span> <span style=color:#a6e22e>socket</span>(AF_INET, SOCK_STREAM, <span style=color:#ae81ff>0</span>)) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(s, SOL_SOCKET, SO_REUSEADDR, <span style=color:#f92672>&amp;</span>yes, <span style=color:#66d9ef>sizeof</span>(yes)); <span style=color:#75715e>// Best effort.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>sa,<span style=color:#ae81ff>0</span>,<span style=color:#66d9ef>sizeof</span>(sa));
</span></span><span style=display:flex><span>    sa.sin_family <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    sa.sin_port <span style=color:#f92672>=</span> <span style=color:#a6e22e>htons</span>(port);
</span></span><span style=display:flex><span>    sa.sin_addr.s_addr <span style=color:#f92672>=</span> <span style=color:#a6e22e>htonl</span>(INADDR_ANY);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>bind</span>(s,(<span style=color:#66d9ef>struct</span> sockaddr<span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>sa,<span style=color:#66d9ef>sizeof</span>(sa)) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>listen</span>(s, <span style=color:#ae81ff>511</span>) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>close</span>(s);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> s;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> sockaddr_in {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>short</span>            sin_family;   <span style=color:#75715e>// e.g. AF_INET, AF_INET6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span>   sin_port;     <span style=color:#75715e>// e.g. htons(3490)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>struct</span> in_addr   sin_addr;     <span style=color:#75715e>// see struct in_addr, below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span>             sin_zero[<span style=color:#ae81ff>8</span>];  <span style=color:#75715e>// zero this if you want to, padding for memory alignment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span></code></pre></div><p>é¦–å…ˆå£°æ˜äº†å˜é‡ï¼Œ<code>s</code> ç”¨äºä¿å­˜æœåŠ¡è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>yes</code> ç”¨äºä¼ é€’ <code>socket</code> è®¾ç½®çš„å‚æ•°é€‰é¡¹ã€‚</p><p><code>socket(AF_INET, SOCK_STREAM, 0)</code> åˆ›å»ºäº†ä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦;
è€Œ <code>AF_INET</code> ç±»å‹çš„ <code>SOCK_STREAM</code> æµå¼å¥—æ¥å­—ç±»å‹ï¼Œæ˜¯æŒ‡ä¸€ç§ä»¥å¤ªç½‘åè®®æ—çš„æµå¼åè®®ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ <code>TCP</code> åè®®ç½‘ç»œå¥—æ¥å­—ã€‚å…¶ä»–çš„ç±»å‹å£°æ˜å¯å‚ç…§ <code>socket.h</code>ã€‚</p><p><code>setsockopt</code> è®¾ç½®å¥—æ¥å­—å‚æ•°é€‰é¡¹ï¼Œ<code>SOL_SOCKET</code>å¸¸é‡æŒ‡æ˜ä¸ºå¥—æ¥å­—ï¼Œ<code>SO_REUSEADDR</code> é€‰é¡¹è¡¨ç¤ºå…è®¸é‡ç”¨æœ¬åœ°åœ°å€å’Œç«¯å£ï¼Œå¯ä»¥åœ¨åŒä¸€ç«¯å£ä¸Šå¯åŠ¨å¤šä¸ªå®ä¾‹ç›‘å¬ã€‚è¿™é‡Œçš„ç”¨é€”æ˜¯åœ¨æœåŠ¡å…³é—­åå¯ä»¥å¿«é€Ÿé‡å¯ï¼Œé¿å…å› æœ¬åœ°ç«¯å£å ç”¨å¯¼è‡´æœåŠ¡å¯åŠ¨å¤±è´¥ï¼ˆå› <code>TCP</code>è¿æ¥é€€å‡ºä¼šä¿æŒä½ åœ¨ <code>TIME_WAIT</code> ä¸€æ®µæ—¶é—´ï¼Œä»¥ç¡®è®¤æ‰€æœ‰åŒ…è¢«æ¥æ”¶ï¼‰ã€‚</p><p>å®Œæˆåœ°å€å‚æ•°<code>sa</code>çš„åˆå§‹åŒ–åï¼Œè°ƒç”¨ <code>bind</code> ç»‘å®šå¥—æ¥å­—åˆ°æœ¬åœ°åœ°å€; ç»‘å®šæˆåŠŸåï¼Œä½¿ç”¨<code>listen</code>æ ‡è®°ä¸ºæœåŠ¡ç«¯å¥—æ¥å­—ï¼Œå¹¶å¼€å§‹ç›‘å¬è¿æ¥è¯·æ±‚ã€‚å…¶ä¸­ <code>listen</code> çš„ç¬¬äºŒä¸ªå‚æ•° <code>511</code> è¡¨ç¤ºè¿æ¥ç­‰å¾…é˜Ÿåˆ—(<code>backlog queue</code>)çš„æœ€å¤§è¿æ¥æ•°ï¼Œå…·ä½“å¯å‚è€ƒ <code>listen</code> çš„æ–‡æ¡£ã€‚</p><pre tabindex=0><code>NAME
     listen â€“ listen for connections on a socket

SYNOPSIS
     #include &lt;sys/socket.h&gt;

     int
     listen(int socket, int backlog);

DESCRIPTION
     Creation of socket-based connections requires several operations.  First, a socket is created with socket(2).  Next, a willingness to accept incoming connections and a queue limit for incoming connections are specified with listen().  Finally, the connections are accepted with accept(2).  The listen() call
     applies only to sockets of type SOCK_STREAM.

     The backlog parameter defines the maximum length for the queue of pending connections.  If a connection request arrives with the queue full, the client may receive an error with an indication of ECONNREFUSED.  Alternatively, if the underlying protocol supports retransmission, the request may be ignored so
     that retries may succeed.
</code></pre><p>è‡³æ­¤ï¼ŒæœåŠ¡ç«¯ç›‘å¬å¥—æ¥å­—åˆ›å»ºå’Œåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥å¼€å§‹æ¥å—å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚äº†ã€‚æ•´ä¸ªåˆå§‹åŒ– <code>initChat</code> å°±å®Œæˆäº†ã€‚</p><hr><p>æ¥ä¸‹æ¥çœ‹ <code>main</code> å‡½æ•°ä¸­å¦‚ä½•å®ç°â€œä¸‰ä»¶äº‹â€çš„ã€‚</p><p>å‚ç…§å‰æ–‡ï¼Œâ€œä¸‰ä»¶äº‹â€åˆ†åˆ«ä¸ºï¼š</p><ol><li>æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼›</li><li>æ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘é€è¿‡æ¥æ–°çš„æ¶ˆæ¯ï¼›</li><li>å‘é€æ¶ˆæ¯ç»™å…¶ä»–å®¢æˆ·ç«¯ï¼›</li></ol><p>ä¸ºäº†æ–¹ä¾¿åœ°å¤„ç†ç½‘ç»œIOè¯»å†™ä¸€èˆ¬ä¼šåšå¤šè·¯å¤ç”¨ã€‚åŸºæœ¬åŸç†æ˜¯è®©ç³»ç»Ÿå¸®æˆ‘ä»¬ç›‘å¬ä¸€ç»„æè¿°ç¬¦ä¸Šçš„è¯»å†™äº‹ä»¶ï¼Œå½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šé€šçŸ¥æˆ‘ä»¬å»å¤„ç†å¯¹åº”çš„äº‹ä»¶ã€‚å¸¸è§çš„IOå¤ç”¨å¤„ç†æ–¹å¼æœ‰: <code>select</code>, <code>poll</code>, <code>epoll</code> ç­‰ï¼Œæ›´å¤šç»†èŠ‚æ¨èã€ŠLinux é«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>ã€‚</p><p>è¿™é‡Œç¨‹åºä¸­é‡‡ç”¨ <code>select</code> æ¥å®ç°ï¼Œä½†å…¶å® <code>epoll</code> ä¼šæ›´é«˜æ•ˆä¸€äº›ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        fd_set readfds;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> timeval tv;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> retval;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>FD_ZERO</span>(<span style=color:#f92672>&amp;</span>readfds);
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* When we want to be notified by select() that there is
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * activity? If the listening socket has pending clients to accept
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * or if any other client wrote anything. */</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>FD_SET</span>(Chat<span style=color:#f92672>-&gt;</span>serversock, <span style=color:#f92672>&amp;</span>readfds);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;=</span> Chat<span style=color:#f92672>-&gt;</span>maxclient; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (Chat<span style=color:#f92672>-&gt;</span>clients[j]) <span style=color:#a6e22e>FD_SET</span>(j, <span style=color:#f92672>&amp;</span>readfds);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* Set a timeout for select(), see later why this may be useful
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * in the future (not now). */</span>
</span></span><span style=display:flex><span>        tv.tv_sec <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>// 1 sec timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        tv.tv_usec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* Select wants as first argument the maximum file descriptor
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * in use plus one. It can be either one of our clients or the
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * server socket itself. */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> maxfd <span style=color:#f92672>=</span> Chat<span style=color:#f92672>-&gt;</span>maxclient;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (maxfd <span style=color:#f92672>&lt;</span> Chat<span style=color:#f92672>-&gt;</span>serversock) maxfd <span style=color:#f92672>=</span> Chat<span style=color:#f92672>-&gt;</span>serversock;
</span></span><span style=display:flex><span>        retval <span style=color:#f92672>=</span> <span style=color:#a6e22e>select</span>(maxfd<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>&amp;</span>readfds, NULL, NULL, <span style=color:#f92672>&amp;</span>tv);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸ºäº†ä½¿ç”¨<code>select</code>, ä»£ç é¦–å…ˆå£°æ˜äº† <code>fd_set</code> ç±»å‹å˜é‡ <code>readfds</code> ç”¨æ¥ä¿å­˜ä¸€ç»„æè¿°ç¬¦ï¼Œå®Œæˆæ¸…é›¶(<code>FD_ZERO(&amp;readfds)</code>) ååˆ†åˆ«æŠŠæœåŠ¡å¥—æ¥å­—å’Œæ‰€æœ‰å®¢æˆ·ç«¯å¥—æ¥å­—æ³¨å†Œåˆ° <code>readfds</code> ä¸Š:</p><ol><li><code>FD_SET(Chat->serversock, &amp;readfds)</code></li><li><code>for (int j = 0; j &lt;= Chat->maxclient; j++) { if (Chat->clients[j]) FD_SET(j, &amp;readfds);}</code></li></ol><p>åŒæ—¶è¿˜å£°æ˜äº†è¶…æ—¶å‚æ•°<code>struct timeval tv</code>ï¼Œå’Œåˆå§‹åŒ–å‚æ•°å€¼ã€‚
æœ€åè°ƒç”¨<code>select</code>æ¥ç›‘å¬å¥—æ¥å­—ä¸Šçš„è¯»å†™äº‹ä»¶ï¼Œç›´åˆ°è¶…æ—¶è¿”å›ã€‚</p><hr><p>æ¥ä¸‹æ¥çœ‹å¦‚ä½•å¤„ç†æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* If the listening socket is &#34;readable&#34;, it actually means
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * there are new clients connections pending to accept. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(Chat<span style=color:#f92672>-&gt;</span>serversock, <span style=color:#f92672>&amp;</span>readfds)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>acceptClient</span>(Chat<span style=color:#f92672>-&gt;</span>serversock);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> client <span style=color:#f92672>*</span>c <span style=color:#f92672>=</span> <span style=color:#a6e22e>createClient</span>(fd);
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Send a welcome message. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>welcome_msg <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Welcome to Simple Chat! &#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Use /nick &lt;nick&gt; to set your nick.</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>write</span>(c<span style=color:#f92672>-&gt;</span>fd,welcome_msg,<span style=color:#a6e22e>strlen</span>(welcome_msg));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Connected client fd=%d</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, fd);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* Create a new client bound to &#39;fd&#39;. This is called when a new client
</span></span></span><span style=display:flex><span><span style=color:#75715e> * connects. As a side effect updates the global Chat state. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> client <span style=color:#f92672>*</span><span style=color:#a6e22e>createClient</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> nick[<span style=color:#ae81ff>32</span>]; <span style=color:#75715e>// Used to create an initial nick for the user.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> nicklen <span style=color:#f92672>=</span> <span style=color:#a6e22e>snprintf</span>(nick,<span style=color:#66d9ef>sizeof</span>(nick),<span style=color:#e6db74>&#34;user:%d&#34;</span>,fd);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> client <span style=color:#f92672>*</span>c <span style=color:#f92672>=</span> <span style=color:#a6e22e>chatMalloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#f92672>*</span>c));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>socketSetNonBlockNoDelay</span>(fd); <span style=color:#75715e>// Pretend this will not fail.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    c<span style=color:#f92672>-&gt;</span>fd <span style=color:#f92672>=</span> fd;
</span></span><span style=display:flex><span>    c<span style=color:#f92672>-&gt;</span>nick <span style=color:#f92672>=</span> <span style=color:#a6e22e>chatMalloc</span>(nicklen<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memcpy</span>(c<span style=color:#f92672>-&gt;</span>nick,nick,nicklen);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>assert</span>(Chat<span style=color:#f92672>-&gt;</span>clients[c<span style=color:#f92672>-&gt;</span>fd] <span style=color:#f92672>==</span> NULL); <span style=color:#75715e>// This should be available.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Chat<span style=color:#f92672>-&gt;</span>clients[c<span style=color:#f92672>-&gt;</span>fd] <span style=color:#f92672>=</span> c;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* We need to update the max client set if needed. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (c<span style=color:#f92672>-&gt;</span>fd <span style=color:#f92672>&gt;</span> Chat<span style=color:#f92672>-&gt;</span>maxclient) Chat<span style=color:#f92672>-&gt;</span>maxclient <span style=color:#f92672>=</span> c<span style=color:#f92672>-&gt;</span>fd;
</span></span><span style=display:flex><span>    Chat<span style=color:#f92672>-&gt;</span>numclients<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> c;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* Set the specified socket in non-blocking mode, with no delay flag. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>socketSetNonBlockNoDelay</span>(<span style=color:#66d9ef>int</span> fd) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> flags, yes <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Set the socket nonblocking.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Note that fcntl(2) for F_GETFL and F_SETFL can&#39;t be
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * interrupted by a signal. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((flags <span style=color:#f92672>=</span> <span style=color:#a6e22e>fcntl</span>(fd, F_GETFL)) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>fcntl</span>(fd, F_SETFL, flags <span style=color:#f92672>|</span> O_NONBLOCK) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* This is best-effort. No need to check for errors. */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setsockopt</span>(fd, IPPROTO_TCP, TCP_NODELAY, <span style=color:#f92672>&amp;</span>yes, <span style=color:#66d9ef>sizeof</span>(yes));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ <code>select</code> è¿”å›åï¼Œé€šè¿‡<code>FD_ISSET</code>æ£€æŸ¥æœåŠ¡å¥—æ¥å­—æ˜¯å¦å¯è¯»ï¼Œå¦‚æœå¯è¯»åˆ™è¡¨ç¤ºæœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œè°ƒç”¨ <code>acceptClient</code> æ¥æ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚å¹¶å‘æ–°çš„å®¢æˆ·ç«¯å‘é€ä¸€æ¡æ¬¢è¿æ¶ˆæ¯ã€‚</p><p><code>createClient</code> å‡½æ•°ç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯å®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼Œå‡½æ•°ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ª <code>client</code> ç»“æ„ä½“ï¼Œå¹¶åˆå§‹åŒ–ä¸€äº›çŠ¶æ€å‚æ•°ï¼ˆå¦‚å®¢æˆ·ç«¯è¿æ¥æ•°ç­‰ï¼‰ï¼Œæœ€åæŠŠæ–°çš„å®¢æˆ·ç«¯è¿æ¥ä¿å­˜åˆ°å…¨å±€å˜é‡ <code>Chat</code> ä¸­ã€‚è¿™é‡Œç¨‹åºé‡‡ç”¨æ–‡ä»¶æè¿°ç¬¦æ•°å€¼ä½œä¸ºæ•°ç»„ä¸‹æ ‡æ¥ä¿å­˜å®¢æˆ·ç«¯è¿æ¥ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥æŸ¥æ‰¾å¯¹åº”çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œä½†æ˜¯å‰å‡ ä½è¢«æ ‡å‡†è¾“å…¥è¾“å‡ºé”™è¯¯ç­‰å ç”¨ï¼Œç¨‹åºä¸­ä¼šå…ˆæ‰¾åˆ°å½“å‰æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åä»è¿™ä¸ªä½ç½®å¼€å§‹ä¿å­˜å®¢æˆ·ç«¯è¿æ¥ã€‚</p><p><code>socketSetNonBlockNoDelay</code> å‡½æ•°ç”¨æ¥è®¾ç½®å¥—æ¥å­—ä¸ºéé˜»å¡æ¨¡å¼ã€‚
åŒæ—¶è®¾ç½® <code>TCP_NODELAY</code> å‚æ•°ï¼Œè¡¨ç¤ºç¦ç”¨ <code>Nagle</code> ç®—æ³•ï¼ˆç”¨äºè‡ªåŠ¨æ‹¼æ¥å°çš„æ–‡æœ¬æ®µï¼Œä»¥æä¾›ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼‰ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†å°½å¿«é€è¾¾å’Œé¿å…æ¶ˆæ¯å»¶è¿Ÿã€‚</p><hr><p>å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Here for each connected client, check if there are pending
</span></span></span><span style=display:flex><span><span style=color:#75715e>    * data the client sent us. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> readbuf[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;=</span> Chat<span style=color:#f92672>-&gt;</span>maxclient; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Chat<span style=color:#f92672>-&gt;</span>clients[j] <span style=color:#f92672>==</span> NULL) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>FD_ISSET</span>(j, <span style=color:#f92672>&amp;</span>readfds)) {
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>       <span style=color:#75715e>/* Here we just hope that there is a well formed
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * message waiting for us. But it is entirely possible
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * that we read just half a message. In a normal program
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * that is not designed to be that simple, we should try
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * to buffer reads until the end-of-the-line is reached. */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nread <span style=color:#f92672>=</span> <span style=color:#a6e22e>read</span>(j,readbuf,<span style=color:#66d9ef>sizeof</span>(readbuf)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        ... 
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>è¿™æ®µä»£ç éå†æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯ã€‚å¦‚æœæœ‰åˆ™è°ƒç”¨ <code>read</code> è¯»å–æ¶ˆæ¯å†…å®¹; å› ä¸ºæ‰€æœ‰çš„å®¢æˆ·ç«¯è¿æ¥éƒ½æ˜¯éé˜»å¡çš„ï¼Œæ‰€ä»¥èƒ½å¤Ÿç«‹åˆ»è¿”å›ç»“æœã€‚ä½†readå¾ˆå¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„æ¶ˆæ¯ï¼Œè¿™é‡Œç¨‹åºç®€å•å¤„ç†ï¼Œç›´æ¥è¯»å–ä¸€è¡Œæ¶ˆæ¯å†…å®¹(çœŸå®çš„å·¥ç¨‹ä¸­ä¼šé€šè¿‡åˆ†éš”ç¬¦æ¥åˆ¤æ–­è¯»å–å®Œå…¨ï¼Œå¦åˆ™ä¼šè¢«åˆ¤å®šä¸ºä¸å®Œæ•´ä¿¡æ¯)ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> (nread <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Error or short read means that the socket
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * was closed. */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Disconnected client fd=%d, nick=%s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>,
</span></span><span style=display:flex><span>        j, Chat<span style=color:#f92672>-&gt;</span>clients[j]<span style=color:#f92672>-&gt;</span>nick);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>freeClient</span>(Chat<span style=color:#f92672>-&gt;</span>clients[j]);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* The client sent us a message. We need to
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * relay this message to all the other clients
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * in the chat. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> client <span style=color:#f92672>*</span>c <span style=color:#f92672>=</span> Chat<span style=color:#f92672>-&gt;</span>clients[j];
</span></span><span style=display:flex><span>    readbuf[nread] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* If the user message starts with &#34;/&#34;, we
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * process it as a client command. So far
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * only the /nick &lt;newnick&gt; command is implemented. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (readbuf[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/&#39;</span>) {
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Create a message to send everybody (and show
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * on the server console) in the form:
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *   nick&gt; some message. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> msg[<span style=color:#ae81ff>256</span>];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> msglen <span style=color:#f92672>=</span> <span style=color:#a6e22e>snprintf</span>(msg, <span style=color:#66d9ef>sizeof</span>(msg),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;%s&gt; %s&#34;</span>, c<span style=color:#f92672>-&gt;</span>nick, readbuf);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;%s&#34;</span>,msg);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Send it to all the other clients. */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sendMsgToAllClientsBut</span>(j,msg,msglen);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ®µä»£ç æ ¹æ®<code>read</code>è¿”å›çš„ç»“æœæ¥è¿›ä¸€æ­¥å¤„ç†ã€‚é¦–å…ˆæ˜¯åˆ¤å®šå®¢æˆ·ç«¯å·²å…³é—­ï¼ˆä¸€èˆ¬éœ€è¦æœ‰ä¸“é—¨çš„å®¢æˆ·ç«¯å…³é—­æŒ‡ä»¤æˆ–è€…å¤šæ¬¡å¿ƒè·³ä¿æ´»åˆ¤å®šï¼‰ï¼Œéœ€è¦å¯¹å®¢æˆ·ç«¯èµ„æºè¿›è¡Œé‡Šæ”¾ï¼Œä»¥åŠçŠ¶æ€æ›´æ–°ã€‚å…¶æ¬¡æ˜¯æ­£å¸¸è¯»å–çš„å®¢æˆ·ç«¯æ¶ˆæ¯ï¼Œè¿™é‡Œæ¶ˆæ¯ç»†åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç§æ˜¯ä»¥<code>/&lt;cmd> content</code>æ ¼å¼çš„æŒ‡ä»¤å†…å®¹ï¼›å¦ä¸€ç§å°±æ˜¯å…¨æ–‡æœ¬æ¶ˆæ¯ï¼Œéœ€è¦åŠ ä¸Šå‘é€äººæ˜µç§°è½¬å‘ç»™å…¶ä»–æ‰€æœ‰äººã€‚</p><p>é’ˆå¯¹â€œæŒ‡ä»¤æ¶ˆæ¯â€çš„å¤„ç†é€»è¾‘å°±æ˜¯å¸¸è§çš„å­—ç¬¦ä¸²å¤„ç†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* If the user message starts with &#34;/&#34;, we
</span></span></span><span style=display:flex><span><span style=color:#75715e> * process it as a client command. So far
</span></span></span><span style=display:flex><span><span style=color:#75715e> * only the /nick &lt;newnick&gt; command is implemented. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (readbuf[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;/&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Remove any trailing newline. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>p;
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> <span style=color:#a6e22e>strchr</span>(readbuf,<span style=color:#e6db74>&#39;\r&#39;</span>); <span style=color:#66d9ef>if</span> (p) <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    p <span style=color:#f92672>=</span> <span style=color:#a6e22e>strchr</span>(readbuf,<span style=color:#e6db74>&#39;\n&#39;</span>); <span style=color:#66d9ef>if</span> (p) <span style=color:#f92672>*</span>p <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Check for an argument of the command, after
</span></span></span><span style=display:flex><span><span style=color:#75715e>        * the space. */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>arg <span style=color:#f92672>=</span> <span style=color:#a6e22e>strchr</span>(readbuf,<span style=color:#e6db74>&#39; &#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (arg) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span>arg <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#75715e>/* Terminate command name. */</span>
</span></span><span style=display:flex><span>        arg<span style=color:#f92672>++</span>; <span style=color:#75715e>/* Argument is 1 byte after the space. */</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>strcmp</span>(readbuf,<span style=color:#e6db74>&#34;/nick&#34;</span>) <span style=color:#f92672>&amp;&amp;</span> arg) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>free</span>(c<span style=color:#f92672>-&gt;</span>nick);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nicklen <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(arg);
</span></span><span style=display:flex><span>        c<span style=color:#f92672>-&gt;</span>nick <span style=color:#f92672>=</span> <span style=color:#a6e22e>chatMalloc</span>(nicklen<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>memcpy</span>(c<span style=color:#f92672>-&gt;</span>nick,arg,nicklen<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* Unsupported command. Send an error. */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>errmsg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Unsupported command</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>write</span>(c<span style=color:#f92672>-&gt;</span>fd,errmsg,<span style=color:#a6e22e>strlen</span>(errmsg));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ ¹æ®é¦–ä½çš„<code>/</code>åˆ¤å®šä¸ºæŒ‡ä»¤æ¶ˆæ¯åï¼Œæ ¹æ®åˆ†éš”æ¢è¡Œæ ‡è¯†å‡ºæ¶ˆæ¯å°¾éƒ¨ï¼ˆå¹¶ç½®é›¶ï¼‰ï¼›
ç„¶ååˆ©ç”¨ç©ºæ ¼åŒºåˆ†å‡ºæŒ‡ä»¤å†…å®¹å’Œæ¶ˆæ¯å†…å®¹ï¼Œä»¥<code>0</code>åˆ†éš”ï¼›
è¯­å¥<code>!strcmp(readbuf "/nick) && arg</code> åˆ¤å®šæŒ‡ä»¤ä¸º<code>/nick</code>åï¼ŒæŠŠæŒ‡ä»¤å†…å®¹<code>arg</code>æŒ‡å‘çš„å­—ç¬¦ä¸²æ‹·è´åèµ‹å€¼åˆ°å®¢æˆ·ç«¯çš„æ˜µç§°å­—æ®µä¸­ã€‚</p><p>è€Œè½¬å‘æ¶ˆæ¯ç»™å…¶ä»–æ‰€æœ‰äººçš„é€»è¾‘åˆ™æ˜¯éå†æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼ŒæŠŠæ¶ˆæ¯å†…å®¹å‘é€ç»™å…¶ä»–æ‰€æœ‰äººï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Send the specified string to all connected clients but the one
</span></span></span><span style=display:flex><span><span style=color:#75715e> * having as socket descriptor &#39;excluded&#39;. If you want to send something
</span></span></span><span style=display:flex><span><span style=color:#75715e> * to every client just set excluded to an impossible socket: -1. */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>sendMsgToAllClientsBut</span>(<span style=color:#66d9ef>int</span> excluded, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>s, <span style=color:#66d9ef>size_t</span> len) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> j <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; j <span style=color:#f92672>&lt;=</span> Chat<span style=color:#f92672>-&gt;</span>maxclient; j<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (Chat<span style=color:#f92672>-&gt;</span>clients[j] <span style=color:#f92672>==</span> NULL <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>            Chat<span style=color:#f92672>-&gt;</span>clients[j]<span style=color:#f92672>-&gt;</span>fd <span style=color:#f92672>==</span> excluded) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* Important: we don&#39;t do ANY BUFFERING. We just use the kernel
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * socket buffers. If the content does not fit, we don&#39;t care.
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * This is needed in order to keep this program simple. */</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>write</span>(Chat<span style=color:#f92672>-&gt;</span>clients[j]<span style=color:#f92672>-&gt;</span>fd,s,len);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å…·ä½“å®ç°å°±æ˜¯éå†æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥ï¼ŒæŠŠæ¶ˆæ¯å†…å®¹å†™å…¥åˆ°å®¢æˆ·ç«¯å¥—æ¥å­—ä¸­(è¿™é‡Œå†™å…¥ä¹Ÿæœ‰å¯èƒ½å¤±è´¥ï¼Œå±•ç¤ºç¨‹åºå¤„äºç®€å•å¹¶æœªå¤„ç†å¯èƒ½çš„é”™è¯¯)ã€‚å…¶ä¸­æœªèµ‹å€¼çš„å®¢æˆ·ç«¯è¿æ¥ å’Œ æŒ‡å®šçš„æ’é™¤å®¢æˆ·ç«¯è¿æ¥ï¼ˆæ¶ˆæ¯æºæœ¬äººï¼‰ä¼šè¢«è·³è¿‡ã€‚</p><p>è‡³æ­¤ï¼Œæ•´ä¸ªç¨‹åºé€»è¾‘å°±å®Œæˆäº†ã€‚</p><p>ä½œä¸ºä¸€ä¸ªå±•ç¤ºæ ·ä¾‹ï¼Œè¿™ç«¯ä»£ç å±•ç¤ºäº†å¦‚ä½•å¤„ç†å†…å­˜ç®¡ç†ã€ç½‘ç»œå¥—æ¥å­—çš„ä½¿ç”¨ã€å¤šè·¯å¤ç”¨ã€å®¢æˆ·ç«¯è¿æ¥çš„ç®¡ç†ã€æ¶ˆæ¯å’ŒæŒ‡ä»¤çš„å¤„ç†ç­‰é€»è¾‘ã€‚é™¤å»æ³¨é‡Šåªæœ‰çŸ­çŸ­ä¸¤ç™¾å¤šè¡Œï¼Œç”¨æ¥å­¦ä¹ å’Œç†è§£æœåŠ¡ç«¯ç¼–ç¨‹å·²ç»è¶³å¤Ÿäº† â€”â€”â€”â€” éº»é›€è™½å°äº”è„ä¿±å…¨ã€‚</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/antirez/smallchat>https://github.com/antirez/smallchat</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>è§†é¢‘åˆ†äº« <a href="https://www.youtube.com/watch?v=eT02gzeLmF0">https://www.youtube.com/watch?v=eT02gzeLmF0</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Linux é«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ <a href=https://book.douban.com/subject/24722611/>https://book.douban.com/subject/24722611/</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></main></body></html>